<%= render "devise/shared/navbar" %>

<div class="page">
    
    <div class= "show-back">
        <%= link_to request.referer || root_path do %>
            <i class="fa-solid fa-arrow-left"></i>
        <% end %>
    </div>


    <div class= "show-page">    
        <div class="banner-image">
            <% if @event.poster_pic.present? %>
                <%= image_tag(@event.poster_pic, alt: "Event Image", class: "event-image")%>
            <% else %>
                <%= image_tag("default-poster.jpg", alt: "Event Image", class: "event-image" )%>
            <% end %>
        </div>

        <div class="event-container">
            <div class="event-header">
                <h1 class="event-title"><%= @event.title %></h1>
                <div class="event-icons">
                    <i 
                    class="fa-regular fa-heart heart-icon" 
                    data-controller="favorite" 
                    data-action="click->favorite#updateFavouriteStatus" 
                    data-favorite-target="icon"
                    data-status=<%= @event.favourited_by?(current_user) %>
                    data-event-id=<%= @event.id %>
                    data-user-id=<%= current_user.id %>
                    data-favourites-id=<%= @event.favourites.find_by(user: current_user)&.id %>></i>

                    <i class="fa-solid fa-share share-icon" data-controller="share" data-action="click->share#copyToClipboard" data-share-target="icon"></i>
                </div>
            </div>

            <div class="event-details">
                <div class="event-info">

                    <h3 class="info-title">Data e Ora di Inizio</h3>
                    <div class="info-temporale">
                        <p class="info-date">
                            <i class="fa-regular fa-calendar"></i>
                            <p><%= l(@event.start_datetime, format: "%A, %d %B %Y").gsub(/\b\w/) { |match| match.upcase } %></p>
                        </p>
                        <p class="info-time">
                            <i class="fa-regular fa-clock"></i>
                            <p><%= @event.start_datetime.strftime("%H:%M") %></p>
                        </p>
                    </div>

                    <h3 class="info-title">Data e Ora di Fine</h3>
                    <div class="info-temporale">
                        <p class="info-date">
                            <i class="fa-regular fa-calendar"></i>
                            <p><%= l(@event.end_datetime, format: "%A, %d %B %Y").gsub(/\b\w/) { |match| match.upcase } %></p>
                        </p>
                        <p class="info-time">
                            <i class="fa-regular fa-clock"></i>
                            <p><%= @event.end_datetime.strftime("%H:%M") %></p>
                        </p>
                    </div>
                </div>

                <% if @event.charity_event? %>
                    <div class="event-buy">
                        <h2>Fai una Donazione</h2>
                        <%= form_with url: cart_items_path(:event_id => @event.id), method: :post do |f| %>
                            <label for="donation_amount">Importo della Donazione (Euro):</label>
                            <%= f.number_field :donation_amount, value: 1, step: 0.01, min: 1.00, required: true %>

                            <%= hidden_field_tag :user_id, current_user.id %>

                            <label for="anonymous">Donare in modo anonimo?</label>
                            <%= f.check_box :anonymous %>

                            <label for="message">Messaggio (facoltativo):</label>
                            <%= f.text_area :message, placeholder: "Lascia un messaggio..." %>

                            <%= f.submit "Dona e Partecipa", class: "btn btn-primary" %>
                        <% end %>
                    </div>
                <% else %>
                    <div class="event-buy">
                        <% if can? :read, @cart%>
                            <% if @event.is_full? %>
                                Non ci sono più biglietti disponibili.
                                <br>
                            <% else %>
                                <%= button_to "Aggiungi al carrello", cart_items_path(:event_id => @event.id), method: :post,  class: "buy-btn"  %>
                                <br>
                            <% end %>
                        <% end %>
                        <div class="tckt-info">
                            <h4>Info Biglietti</h4>
                            <% if @event.event_price == 0.0 %>
                                <div class="tckt-div">
                                    <p><i class="fa-solid fa-ticket"></i></p>
                                    <p>Gratis</p>
                                </div>
                            <% else %>
                                <div class="tckt-div">
                                    <p><i class="fa-solid fa-ticket"></i></p>
                                    <p><%= number_to_currency(@event.event_price) %></p>
                                </div>
                            <% end %>
                        </div>
                    </div>
                <% end %>
            </div>

            <div class="event-location">
                <h3>Location</h3>
                <div class="info-loc">
                    <p><i class="fa-solid fa-location-dot"></i><%= @event.address+", "+@event.city+", "+@event.country%></p>
                    <div class="map"></div>
                </div>
            </div>

            <div class="event-host">
                <h3>Organizzato Da</h3>
                <%= link_to user_path(@organizer.id), style: "text-decoration: none;" do%>
                    <div class="host-info">
                        <% if @organizer.profile_pic.present? %>
                            <%= image_tag(@organizer.profile_pic, class: "host-image" )%>
                        <% else %>
                            <%= image_tag("default-avatar.png", class: "host-image" )%>
                        <% end %>
                        <%#= image_tag "Profile.png", class: "host-image" %>
                        <div class="host-details">
                            <p class="host-name"><%= @organizer.first_name %></p>
                            <!--p><%= link_to @organizer.first_name, user_path(@organizer.id)%></p-->
                            <!--button class="follow-btn">Visita</button-->
                        </div>
                    </div>
                <% end %>
            </div>

            <div class="event-description">
                <h3>Descrizione</h3>
                <div class="info-desc">
                    <p><%= @event.description %></p>
                </div>
            </div>

            <div class="tags">
                <h3>Categoria</h3>
                <div class="tag-list">
                    <span class="tag"><%= @event.category %></span>
                </div>
            </div>

            <div class="reviews-section">
                <% if @event.has_ended? %>
                    <% if @event.reviews.any? %>
                        <% @event.reviews.each do |review| %>
                            <div class="review-card">
                                <div class="review-header">
                                    <p class="review-user"><%= review.user.first_name %></p>
                                </div>
                                <div class="review-content">
                                    <p><%= review.content %></p>
                                </div>
                                <div class="review-rating" data-controller="stars" data-stars-rating-value="<%= review.rating %>">
                                    
                                </div>
                            </div>
                        <% end %>
                    <% else %>
                        <p class="no-reviews">Non ci sono ancora recensioni per questo evento.</p>
                    <% end %>
                <% end %>
            </div>


            <div class="others">
                <h3>Altri eventi che possono piacerti</h3>
                <div class="event-suggestions">
                    <% @events.where("category = ?", @event.category).limit(3).each do |other_event|%>
                        <%= link_to event_path(other_event.id), class: "event-card-link" do %>
                            <div class="event-card">
                                <div class="event-design">
                                    <% if other_event.poster_pic.present? %>
                                        <%= image_tag(other_event.poster_pic, alt: "Event Image", class: "event-image")%>
                                    <% else %>
                                        <%= image_tag("default-poster.jpg", alt: "Event Image", class: "event-image" )%>
                                    <% end %>
                                </div>

                                <div class="event-frame">
                                    <h3 class="other-event-title"><%= other_event.title %></h3>
                                    <p class="other-event-location"><%= other_event.address+", "+other_event.city+", "+other_event.country %></p>
                                    <div class="other-event-date">
                                        <span class="other-month"><%= other_event.start_datetime.strftime("%b") %></span>
                                        <span class="other-day"><%= other_event.start_datetime.strftime("%d") %></span>
                                    </div>
                                    <p class="other-event-time"><%= other_event.start_datetime.strftime("%H:%M") %></p>
                                    <% if other_event.event_price == 0 || other_event.event_price == nil %>
                                        <p class="other-event-price">Gratis</p>
                                    <% else %>
                                        <p class="other-event-price"><%= number_to_currency(other_event.event_price, unit: "€") %></p>
                                    <% end %>
                                </div>
                            </div>
                        <% end %>
                    <% end %>
                </div>
            </div>
        </div>
    </div>

</div>
<%= render "devise/shared/footer" %>
